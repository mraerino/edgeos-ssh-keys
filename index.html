<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>EdgeOS SSH Keys</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <script type="module">
    import { h, render } from 'https://esm.sh/preact';
    import { useState, useCallback, useEffect } from 'https://esm.sh/preact/hooks';
    import htm from 'https://esm.sh/htm';

    const html = htm.bind(h);

    function debounce(func, wait) {
      let timeout
      return function (...args) {
        const context = this
        clearTimeout(timeout)
        timeout = setTimeout(() => func.apply(context, args), wait)
      }
    }

    const App = () => {
      const [username, setUsername] = useState("");
      const [config, setConfig] = useState("");

      const search = useCallback(debounce((name) => {
        console.log("searching", name);
        if (name === "") {
          return () => { }
        }

        const controller = new AbortController();
        (async () => {
          try {
            const response = await fetch(
              `https://api.github.com/users/${encodeURIComponent(name)}/keys`,
              { signal: controller.signal },
            );
            if (response.ok) {
              let output = "";
              const keys = await response.json()
              for (const [i, entry] of keys.entries()) {
                const space = entry.key.indexOf(" ")
                if (space === -1) {
                  continue
                }
                const keyType = entry.key.substring(0, space)
                const pubKey = entry.key.substring(space + 1)
                if (keyType !== "" && pubKey !== "") {
                  output += `set system login user ubnt authentication public-keys ${name}${i + 1} type ${keyType}\n`
                  output += `set system login user ubnt authentication public-keys ${name}${i + 1} key ${pubKey}\n`
                }
                console.log({ keyType, pubKey })
              }
              setConfig(output)
            }
          } catch { }
        })()

        return () => controller.abort()
      }, 1000), [setConfig]);
      useEffect(() => search(username), [username])

      return html`
        <div>
          <input type="text" value=${username}
            onInput=${(e) => setUsername(e.currentTarget.value)}
          />
          <pre>
            ${config}
          </pre>
        </div>
      `
    }

    render(html`<${App} />`, document.body);
  </script>
</body>

</html>